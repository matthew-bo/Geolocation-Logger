(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[71],{28659:function(e,o,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/log-drink",function(){return t(11432)}])},11432:function(e,o,t){"use strict";t.r(o),t.d(o,{default:function(){return O}});var n=t(85893),a=t(67294),l=t(11163),r=t(91440),i=t(5616),c=t(66242),s=t(93946),d=t(15861),u=t(66672),p=t(61903),g=t(94054),h=t(33841),f=t(85945),v=t(18972),m=t(69417),b=t(5970),x=t(46901),y=t(90948),I=t(75244),w=t(36400),j=t(53630),k=t(92098),Z=t(42498),C=t(90109);let N="pk.eyJ1IjoibWJvMTE1NzAiLCJhIjoiY204Z3JuZHYxMGRqNTJucHM0cmR6MzZreCJ9.LfVRa4SdvgFmftOTn1hSwQ",P=e=>{var o,t,n,a,l,r,i,c,s,d,u,p,g,h,f,v,m;if(console.log("Processing location for drink:",{id:e.id,hasLocation:!!e.location,hasPlaceInfo:!!e.placeInfo,customName:null===(o=e.placeInfo)||void 0===o?void 0:o.customName,placeName:null===(t=e.placeInfo)||void 0===t?void 0:t.placeName,address:null===(n=e.placeInfo)||void 0===n?void 0:n.address,neighborhood:null===(a=e.placeInfo)||void 0===a?void 0:a.neighborhood,city:null===(l=e.placeInfo)||void 0===l?void 0:l.city,region:null===(r=e.placeInfo)||void 0===r?void 0:r.region,coords:e.location?"".concat(e.location.lat,",").concat(e.location.lng):"none"}),null===(i=e.placeInfo)||void 0===i?void 0:i.customName)return e.placeInfo.customName;if(null===(c=e.placeInfo)||void 0===c?void 0:c.placeName)return e.placeInfo.placeName;if(null===(s=e.placeInfo)||void 0===s?void 0:s.address){let o=e.placeInfo.address;if(o.includes("(")&&o.includes(",")){if(null===(g=e.placeInfo)||void 0===g?void 0:g.neighborhood)return e.placeInfo.neighborhood;if((null===(h=e.placeInfo)||void 0===h?void 0:h.city)&&(null===(f=e.placeInfo)||void 0===f?void 0:f.region))return"".concat(e.placeInfo.city,", ").concat(e.placeInfo.region)}return(null===(p=e.placeInfo)||void 0===p?void 0:p.country)&&(o=o.replace(", ".concat(e.placeInfo.country),"")),o}return(null===(d=e.placeInfo)||void 0===d?void 0:d.neighborhood)?e.placeInfo.neighborhood:(null===(u=e.placeInfo)||void 0===u?void 0:u.city)?"".concat(e.placeInfo.city).concat(e.placeInfo.region?", ".concat(e.placeInfo.region):""):e.location&&"number"==typeof e.location.lat&&"number"==typeof e.location.lng?(null===(v=e.placeInfo)||void 0===v?void 0:v.nearestCity)?"Location near ".concat(e.placeInfo.nearestCity):(null===(m=e.placeInfo)||void 0===m?void 0:m.region)?"Location in ".concat(e.placeInfo.region):"Location at (".concat(e.location.lat.toFixed(6),", ").concat(e.location.lng.toFixed(6),")"):"Unknown Location"},_={async getPlaceFromCoordinates(e){if(!e||!e.lat||!e.lng)return console.error("Invalid coordinates provided",e),null;try{var o,t,n,a,l,r,i,c,s;let d="https://api.mapbox.com/geocoding/v5/mapbox.places/".concat(e.lng,",").concat(e.lat,".json?access_token=").concat(N,"&types=poi"),u=await fetch(d),p=await u.json();if(p.features&&p.features.length>0){let e=p.features[0],r=e.place_name,i=e.text,c=(null===(o=e.properties)||void 0===o?void 0:o.category)||"unknown",s=(null===(t=p.features.find(e=>e.place_type.includes("neighborhood")))||void 0===t?void 0:t.text)||"",d=(null===(n=p.features.find(e=>e.place_type.includes("place")))||void 0===n?void 0:n.text)||"",u=(null===(a=p.features.find(e=>e.place_type.includes("region")))||void 0===a?void 0:a.text)||"",g=(null===(l=p.features.find(e=>e.place_type.includes("country")))||void 0===l?void 0:l.text)||"";return{placeName:i,placeType:c,address:r,neighborhood:s,city:d,region:u,country:g,isAutomaticallyGenerated:!0}}let g="https://api.mapbox.com/geocoding/v5/mapbox.places/".concat(e.lng,",").concat(e.lat,".json?access_token=").concat(N),h=await fetch(g),f=await h.json();if(f.features&&f.features.length>0){let e=f.features[0].place_name,o=(null===(r=f.features.find(e=>e.place_type.includes("neighborhood")))||void 0===r?void 0:r.text)||"",t=(null===(i=f.features.find(e=>e.place_type.includes("place")))||void 0===i?void 0:i.text)||"",n=(null===(c=f.features.find(e=>e.place_type.includes("region")))||void 0===c?void 0:c.text)||"",a=(null===(s=f.features.find(e=>e.place_type.includes("country")))||void 0===s?void 0:s.text)||"";return{placeName:"Unknown Location",placeType:"location",address:e,neighborhood:o,city:t,region:n,country:a,isAutomaticallyGenerated:!0}}return null}catch(e){return console.error("Error getting place info from coordinates:",e),null}},async updateDrinkLocation(e,o){try{if(!e)return!1;let t=(0,C.JU)(Z.db,"drinks",e);return await (0,C.r7)(t,{placeInfo:o}),!0}catch(e){return console.error("Error updating drink location:",e),!1}},async getLocationStats(e){try{return{topPlaces:[],visitedCities:[],visitedCountries:[]}}catch(e){return console.error("Error getting location stats:",e),null}},getDisplayNameForLocation:P,getLocationStats:e=>{try{console.log("Processing ".concat(e.length," drinks for location stats"));let o=e.reduce((e,o)=>{var t,n,a,l;return e.total++,o.location&&e.withLocation++,o.placeInfo&&e.withPlaceInfo++,(null===(t=o.placeInfo)||void 0===t?void 0:t.customName)&&e.withCustomName++,(null===(n=o.placeInfo)||void 0===n?void 0:n.placeName)&&e.withPlaceName++,(null===(a=o.placeInfo)||void 0===a?void 0:a.address)&&e.withAddress++,(null===(l=o.placeInfo)||void 0===l?void 0:l.city)&&e.withCity++,e},{total:0,withLocation:0,withPlaceInfo:0,withCustomName:0,withPlaceName:0,withAddress:0,withCity:0});console.log("Drink location data summary:",o);let t=e.filter(e=>{var o,t,n;return e.location&&(e.location.lat||e.location.lng||(null===(o=e.placeInfo)||void 0===o?void 0:o.placeName)||(null===(t=e.placeInfo)||void 0===t?void 0:t.address)||(null===(n=e.placeInfo)||void 0===n?void 0:n.city))});if(console.log("Found ".concat(t.length," drinks with usable location data")),0===t.length)return{topPlaces:[],visitedCities:[],visitedStates:[],visitedCountries:[]};let n={},a={},l={},r={},i={};t.forEach(e=>{var o,t,c;let s=P(e);if(i[s]||(i[s]={firstDrinkId:e.id,placeInfo:{...e.placeInfo},coords:e.location?{lat:e.location.lat,lng:e.location.lng}:null}),n[s]=(n[s]||0)+1,null===(o=e.placeInfo)||void 0===o?void 0:o.city){let o=e.placeInfo.city;a[o]=(a[o]||0)+1}if(null===(t=e.placeInfo)||void 0===t?void 0:t.region){let o=e.placeInfo.region;l[o]=(l[o]||0)+1}if(null===(c=e.placeInfo)||void 0===c?void 0:c.country){let o=e.placeInfo.country;r[o]=(r[o]||0)+1}}),console.log("Place name mapping:",i);let c=Object.entries(n).map(e=>{let[o,t]=e;return{name:o,count:t}}).sort((e,o)=>o.count-e.count),s=Object.entries(a).map(e=>{let[o,t]=e;return{name:o,count:t}}).sort((e,o)=>o.count-e.count),d=Object.entries(l).map(e=>{let[o,t]=e;return{name:o,count:t}}).sort((e,o)=>o.count-e.count),u=Object.entries(r).map(e=>{let[o,t]=e;return{name:o,count:t}}).sort((e,o)=>o.count-e.count);return console.log("Top places: ".concat(JSON.stringify(c.slice(0,3)))),{topPlaces:c,visitedCities:s,visitedStates:d,visitedCountries:u}}catch(e){return console.error("Error calculating location stats:",e),{topPlaces:[],visitedCities:[],visitedStates:[],visitedCountries:[]}}}};var S=t(91444);let D=(0,y.ZP)(r.Z)({"& .MuiRating-iconFilled":{color:"var(--beer-amber)"},"& .MuiRating-iconHover":{color:"var(--copper)"}}),L=[{value:12,label:"Standard (12 oz)"},{value:16,label:"Guinness (16 oz)"},{value:18,label:"Mid-West Tall Boy (18 oz)"},{value:24,label:"Tall Boy (24 oz)"},{value:0,label:"Other"}],A=e=>{let{delay:o,size:t,left:a}=e;return(0,n.jsx)("div",{className:"bubble",style:{width:t,height:t,left:"".concat(a,"%"),bottom:"-100px",animation:"float 3s infinite ease-in-out ".concat(o,"s"),opacity:.5*Math.random()+.1}})};function O(){var e,o;let t=(0,l.useRouter)(),{user:r}=(0,k.a)(),[y,N]=(0,a.useState)(null),[P,O]=(0,a.useState)(!1),[E,T]=(0,a.useState)([]),[z,B]=(0,a.useState)(!1),[J,M]=(0,a.useState)(""),[q,F]=(0,a.useState)({brand:"",containerType:"",amount:12,rating:0,notes:"",method:""}),U=Array.from({length:8},(e,o)=>({id:o,size:20*Math.random()+10,left:100*Math.random(),delay:2*Math.random()}));(0,a.useEffect)(()=>{if(!r){t.push("/login");return}navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{N({lat:e.coords.latitude,lng:e.coords.longitude})},e=>{console.error("Error getting location:",e)}),W()},[r,t]);let W=async()=>{try{let e=(0,C.IO)((0,C.hJ)(Z.db,"drinks"),(0,C.ar)("userId","==",r.uid)),o=await (0,C.PL)(e),t=[...new Set(o.docs.map(e=>e.data().brand).filter(Boolean))];T(t)}catch(e){console.error("Error fetching previous brands:",e)}},R=async e=>{if(e.preventDefault(),!y)return;let o=0===q.amount&&J?Number(J):q.amount;if(!q.brand||!q.containerType||0===q.amount&&!J){S.Am.error("Please fill in all required fields",{position:"top-center",autoClose:3e3,theme:"dark"});return}O(!0);try{let e=null;try{e=await _.getPlaceFromCoordinates(y),console.log("Place info retrieved:",e)}catch(e){console.error("Error getting place info:",e)}await (0,C.ET)((0,C.hJ)(Z.db,"drinks"),{...q,amount:o,userId:r.uid,location:y,timestamp:(0,C.Bt)(),placeInfo:e||null}),await G(r.uid,q.brand),B(!0),setTimeout(()=>{t.push("/profile")},1500)}catch(e){console.error("Error logging drink:",e)}finally{O(!1)}},G=async(e,o)=>{try{let t;let n=(0,C.IO)((0,C.hJ)(Z.db,"groups"),(0,C.ar)("members","array-contains",e)),a=await (0,C.PL)(n);if(a.empty){console.log("User is not in any groups, no challenges to update");return}let l=a.docs.map(e=>e.id);if(0===l.length){console.log("No group IDs found for user, no challenges to update");return}console.log("Found ".concat(l.length," groups for user: ").concat(l.join(", "))),t=1===l.length?(0,C.IO)((0,C.hJ)(Z.db,"challenges"),(0,C.ar)("groupId","==",l[0]),(0,C.ar)("status","==","active"),(0,C.ar)("endDate",">",new Date)):(0,C.IO)((0,C.hJ)(Z.db,"challenges"),(0,C.ar)("groupId","in",l),(0,C.ar)("status","==","active"),(0,C.ar)("endDate",">",new Date));let r=await (0,C.PL)(t);if(console.log("Found ".concat(r.size," active challenges for user")),r.empty){console.log("No active challenges found for user");return}let i=(0,C.qs)(Z.db),c=!1;for(let t of r.docs){let n={id:t.id,...t.data()};console.log("Processing challenge: ".concat(n.id," - ").concat(n.name));let a=n.participants.findIndex(o=>o.userId===e);if(console.log("Participant index for user ".concat(e,": ").concat(a)),-1===a){console.log("User ".concat(e," not found in challenge participants"));continue}let l=!1;if("total_beers"===n.type)console.log("Updating total_beers challenge - before: ".concat(n.participants[a].progress)),n.participants[a].progress+=1,console.log("After update: ".concat(n.participants[a].progress)),l=!0;else if("unique_beers"===n.type&&o){let e=n.participants[a].loggedBrands||[];console.log('Checking if brand "'.concat(o,"\" is in user's logged brands: [").concat(e.join(", "),"]")),e.includes(o)?console.log('Brand "'.concat(o,'" already logged, not incrementing unique beers count')):(console.log('Adding new unique brand "'.concat(o,'" to challenge progress')),n.participants[a].progress+=1,n.participants[a].loggedBrands||(n.participants[a].loggedBrands=[]),n.participants[a].loggedBrands.push(o),l=!0)}else if("streak"===n.type){let e;let o=new Date().toDateString();console.log("Processing streak challenge for ".concat(o));let t=n.participants[a].progress||0;console.log("Current streak: ".concat(t));let r=n.participants[a].lastUpdated;e=r&&r.toDate?r.toDate().toDateString():r?new Date(r).toDateString():null,console.log("Last updated: ".concat(e||"never"));let i=new Date;i.setDate(i.getDate()-1);let c=i.toDateString();console.log("Yesterday: ".concat(c)),e!==o?(e===c?(console.log("Continuing streak"),n.participants[a].progress+=1):(e&&0!==t?console.log("Streak broken, resetting to 1"):console.log("Starting new streak"),n.participants[a].progress=1),l=!0):console.log("Already logged a drink today, streak not updated")}l&&(console.log("Updating challenge ".concat(n.id)),n.participants[a].lastUpdated=new Date,i.update((0,C.JU)(Z.db,"challenges",n.id),{participants:n.participants}),c=!0)}c?(console.log("Committing batch updates to challenges"),await i.commit(),console.log("Successfully updated challenges")):console.log("No challenge updates to apply")}catch(e){console.error("Error updating challenges:",e)}},H=e=>{let{name:o,value:t}=e.target;F(e=>({...e,[o]:t}))};return(0,n.jsxs)(i.Z,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",position:"relative",overflow:"hidden",pt:10,px:2},children:[U.map(e=>(0,n.jsx)(A,{...e},e.id)),(0,n.jsxs)(c.Z,{className:"glass-card",sx:{width:"100%",maxWidth:500,p:4,position:"relative",zIndex:1},children:[(0,n.jsxs)(i.Z,{sx:{textAlign:"center",mb:4},children:[(0,n.jsx)(s.Z,{sx:{width:80,height:80,mb:2,background:"var(--glass-background)","&:hover":{background:"var(--glass-background)"}},children:(0,n.jsx)(I.Z,{sx:{fontSize:40,color:"var(--beer-amber)"}})}),(0,n.jsx)(d.Z,{variant:"h4",className:"logo-text",gutterBottom:!0,children:"Log Your Beer"})]}),(0,n.jsxs)("form",{onSubmit:R,children:[(0,n.jsx)(u.Z,{freeSolo:!0,options:E,value:q.brand,onChange:(e,o)=>{F(e=>({...e,brand:o}))},renderInput:e=>(0,n.jsx)(p.Z,{...e,label:"Beer Brand",name:"brand",required:!0,inputProps:{...e.inputProps,maxLength:100,pattern:"[A-Za-z0-9 '&-]*",title:"Only letters, numbers, spaces, apostrophes, ampersands, and hyphens are allowed"},sx:{mb:3},onChange:e=>{let o=e.target.value.replace(/[^A-Za-z0-9 '&-]/g,"");F(e=>({...e,brand:o}))}})}),(0,n.jsxs)(g.Z,{fullWidth:!0,sx:{mb:3},children:[(0,n.jsx)(h.Z,{children:"Container"}),(0,n.jsxs)(f.Z,{name:"containerType",value:q.containerType,onChange:H,required:!0,sx:{background:"var(--glass-background)",backdropFilter:"blur(10px)"},children:[(0,n.jsx)(v.Z,{value:"pint",children:"Pint Glass"}),(0,n.jsx)(v.Z,{value:"bottle",children:"Bottle"}),(0,n.jsx)(v.Z,{value:"can",children:"Can"}),(0,n.jsx)(v.Z,{value:"mug",children:"Mug"}),(0,n.jsx)(v.Z,{value:"other",children:"Other"})]})]}),(0,n.jsxs)(g.Z,{fullWidth:!0,sx:{mt:2},children:[(0,n.jsx)(h.Z,{children:"Amount"}),(0,n.jsx)(f.Z,{value:0===q.amount?0:q.amount,onChange:e=>{let o=e.target.value;0===o?F(e=>({...e,amount:0})):F(e=>({...e,amount:o})),M("")},label:"Amount",required:!0,children:L.map(e=>(0,n.jsx)(v.Z,{value:e.value,children:e.label},e.value))})]}),0===q.amount&&(0,n.jsx)(p.Z,{fullWidth:!0,sx:{mt:2},label:"Custom Amount (oz)",type:"number",value:J,onChange:e=>{let o=e.target.value;(""===o||999>=Number(o)&&o.length<=3)&&(M(o),o&&!isNaN(o)&&F(e=>({...e,amount:0})))},InputProps:{inputProps:{min:1,max:999,maxLength:3}},required:!0}),(0,n.jsxs)(i.Z,{sx:{mb:3,textAlign:"center"},children:[(0,n.jsx)(d.Z,{gutterBottom:!0,color:"var(--text-secondary)",children:"Rating (Optional)"}),(0,n.jsx)(D,{name:"rating",value:q.rating,onChange:(e,o)=>F(e=>({...e,rating:o})),icon:(0,n.jsx)(w.Z,{fontSize:"inherit"}),size:"large"})]}),(0,n.jsx)(p.Z,{fullWidth:!0,multiline:!0,rows:3,name:"notes",label:"Tasting Notes (Optional)",value:q.notes,onChange:H,inputProps:{maxLength:500},helperText:"".concat((null===(e=q.notes)||void 0===e?void 0:e.length)||0,"/500"),sx:{mb:3}}),(0,n.jsx)(p.Z,{fullWidth:!0,name:"method",label:"Method (Optional)",value:q.method,onChange:H,placeholder:"e.g., funnel, shotgun, chug",inputProps:{maxLength:50,pattern:"[A-Za-z0-9 -]*",title:"Only letters, numbers, spaces, and hyphens are allowed"},helperText:"".concat((null===(o=q.method)||void 0===o?void 0:o.length)||0,"/50"),sx:{mb:3}}),(0,n.jsxs)(i.Z,{sx:{display:"flex",alignItems:"center",mb:3},children:[(0,n.jsx)(j.Z,{sx:{color:y?"var(--beer-amber)":"var(--text-secondary)",mr:1}}),(0,n.jsx)(d.Z,{color:y?"var(--text-primary)":"var(--text-secondary)",children:y?"Location captured":"Acquiring location..."})]}),(0,n.jsx)(m.Z,{type:"submit",fullWidth:!0,variant:"contained",disabled:P||!y,sx:{background:"var(--beer-amber)",color:"var(--dark-wood)","&:hover":{background:"var(--copper)"}},children:P?"Logging...":"Log Beer"})]})]}),(0,n.jsx)(b.Z,{open:z,autoHideDuration:3e3,onClose:()=>B(!1),anchorOrigin:{vertical:"top",horizontal:"center"},children:(0,n.jsx)(x.Z,{onClose:()=>B(!1),severity:"success",sx:{width:"100%",bgcolor:"rgba(46, 125, 50, 0.9)",color:"white","& .MuiAlert-icon":{color:"white"}},children:"\uD83C\uDF7A Beer logged successfully!"})})]})}}},function(e){e.O(0,[903,294,699,423,440,774,888,179],function(){return e(e.s=28659)}),_N_E=e.O()}]);